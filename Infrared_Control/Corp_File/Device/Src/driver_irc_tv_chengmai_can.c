/******************************************************************************
 *                                  头文件
*******************************************************************************/
#include "driver_irc_tv_chengmai_can.h"
#include "system_ringbuffer.h"
#include "driver_irc.h"
#include <stdlib.h>
#include <string.h>
/******************************************************************************
 *                            定义红外遥控控制变量
*******************************************************************************/
static IRC_CHENGMAI_CAN_TV_STRUCT irc_can_tv;
static ringbuffer_s ringbuffer_can_tv;

const uint16_t chengmai_can_tv_timing_onoff[] = { 
	0x2340, 0x1184, 0x0256, 0x0680, 0x0256, 0x0682, 0x0254, 0x0216, 0x0252, 0x021A, 0x0252, 0x0686, 0x0254, 0x0680, 0x0254, 0x0216, 0x0254, 0x0686,
	0x0252, 0x0216, 0x0254, 0x0218, 0x0254, 0x0684, 0x0256, 0x0680, 0x0254, 0x0682, 0x0256, 0x0680, 0x0256, 0x0680, 0x0254, 0x0216, 0x023C, 0x0230,
	0x0252, 0x021A, 0x023A, 0x069E, 0x0254, 0x0682, 0x0254, 0x0682, 0x0254, 0x0216, 0x0252, 0x0686, 0x0254, 0x0682, 0x0254, 0x0682, 0x0254, 0x0682,
	0x0254, 0x0216, 0x0252, 0x021A, 0x0252, 0x021A, 0x0252, 0x0686, 0x0254, 0x0218, 0x0252, 0x021A, 0x0250, 0x9306, 0x233C, 0x08CE, 0x0242, 0xBC80,
	0x0010, 0xBC70, 0x233E, 0x08BC, 0x0256, 0x0100};

const uint16_t chengmai_can_tv_timing_volume_plus[] = {
	0x233C, 0x1186, 0x0254, 0x0680, 0x0254, 0x0682, 0x0254, 0x0218, 0x0252, 0x021A, 0x0252, 0x0684, 0x0254, 0x0680, 0x0254, 0x0218, 0x0254, 0x0682,
	0x0254, 0x0218, 0x0254, 0x0218, 0x0254, 0x0682, 0x0254, 0x0682, 0x0254, 0x0680, 0x0254, 0x0682, 0x0254, 0x0682, 0x0254, 0x0218, 0x0252, 0x0684,
	0x0254, 0x0680, 0x0256, 0x0680, 0x0254, 0x0218, 0x0254, 0x0682, 0x0254, 0x0218, 0x0254, 0x021A, 0x0252, 0x0682, 0x0254, 0x021A, 0x0252, 0x021A,
	0x0252, 0x021A, 0x0252, 0x0684, 0x0252, 0x021A, 0x0252, 0x0682, 0x0254, 0x0682, 0x0252, 0x021A, 0x0252, 0x92F8, 0x233C, 0x08BE, 0x0250, 0xBC80,
	0x0010, 0xBC70, 0x233E, 0x08BC, 0x0256, 0x0100};
	/*0x0252, 0x021A, 0x0252, 0x0684, 0x0252, 0x021A, 0x0252, 0x0682, 0x0254, 0x0682, 0x0252, 0x021A, 0x0252, 0x92F8, 0x233C, 0x08BE, 0x0250, 0x178F2,
	0x233E, 0x08BC, 0x0256, 0x0100};*/

const uint16_t chengmai_can_tv_timing_volume_reduce[] = {
	0x2340, 0x1184, 0x0254, 0x0684, 0x0254, 0x0680, 0x0256, 0x0218, 0x0254, 0x0218, 0x0254, 0x0682, 0x0254, 0x0682, 0x0256, 0x0216, 0x0254, 0x0682,
	0x0256, 0x0216, 0x0254, 0x021A, 0x0254, 0x0682, 0x0256, 0x0680, 0x0256, 0x0680, 0x0256, 0x0680, 0x0256, 0x0680, 0x0256, 0x0218, 0x0254, 0x0218,
	0x0254, 0x0682, 0x0256, 0x0680, 0x0256, 0x0216, 0x0254, 0x0682, 0x0256, 0x0218, 0x0254, 0x0218, 0x0254, 0x0682, 0x0256, 0x0680, 0x0256, 0x0216,
	0x0254, 0x021A, 0x0252, 0x0684, 0x0256, 0x0216, 0x0254, 0x0682, 0x0254, 0x0682, 0x0256, 0x0216, 0x0254, 0x9302, 0x2340, 0x08BC, 0x0254, 0xBC80,
	0x0010, 0xBC70, 0x233E, 0x08BC, 0x0256, 0x0100};
	/*0x0254, 0x021A, 0x0252, 0x0684, 0x0256, 0x0216, 0x0254, 0x0682, 0x0254, 0x0682, 0x0256, 0x0216, 0x0254, 0x9302, 0x2340, 0x08BC, 0x0254,	0x178F2,
	0x233E, 0x08BC, 0x0256, 0x0100};*/

const uint16_t chengmai_can_tv_timing_mutte[] = {
    0x2340, 0x118A, 0x0254, 0x0682, 0x0254, 0x0682, 0x0254, 0x0218, 0x0254, 0x0218, 0x0254, 0x0684, 0x0254, 0x0680, 0x0254, 0x0218, 0x0254, 0x0684,
	0x0254, 0x0218, 0x0252, 0x021A, 0x0254, 0x0682, 0x0256, 0x0682, 0x0254, 0x0682, 0x0254, 0x0682, 0x0254, 0x0684, 0x0254, 0x0218, 0x0254, 0x0218,
	0x0254, 0x021A, 0x0252, 0x0684, 0x0254, 0x0684, 0x0254, 0x0682, 0x0254, 0x0218, 0x0254, 0x0218, 0x0254, 0x0684, 0x0254, 0x0682, 0x0254, 0x0684,
	0x0254, 0x0216, 0x0254, 0x021A, 0x0254, 0x0218, 0x0256, 0x0682, 0x0254, 0x0682, 0x0254, 0x0218, 0x0254, 0x930A, 0x2342, 0x08BA, 0x0256, 0xBC80,
	0x0010, 0xBC70, 0x233E, 0x08BE, 0x0252, 0x0100};

const uint16_t chengmai_can_timing_up[] = {
    0x2340, 0x1184, 0x0256, 0x0694, 0x0242, 0x0696, 0x0240, 0x0218, 0x0254, 0x0218, 0x0254, 0x0696, 0x0242, 0x0680, 0x0256, 0x0216, 0x0254, 0x0696,
	0x0244, 0x0216, 0x0254, 0x0218, 0x0254, 0x0682, 0x0256, 0x0682, 0x0254, 0x0682, 0x0256, 0x0692, 0x0242, 0x0680, 0x0256, 0x0216, 0x0256, 0x0680,
	0x0254, 0x0218, 0x0256, 0x067E, 0x0256, 0x0216, 0x0256, 0x0216, 0x0256, 0x0216, 0x0256, 0x0218, 0x0254, 0x0682, 0x0254, 0x0216, 0x0256, 0x0680,
	0x0252, 0x0218, 0x0256, 0x0680, 0x023C, 0x069A, 0x0252, 0x0684, 0x0254, 0x0680, 0x0250, 0x021C, 0x023C, 0x9310, 0x2324, 0x08D4, 0x023A, 0xBC80,
	0x0010, 0xBC70, 0x2326, 0x08D4, 0x0252, 0x0100 };

const uint16_t chengmai_can_timing_down[] = {
    0x233E, 0x1186, 0x0254, 0x0682, 0x0254, 0x0684, 0x0252, 0x021A, 0x0250, 0x021C, 0x0252, 0x0696, 0x0242, 0x0694, 0x0242, 0x0218, 0x0254, 0x0682,
	0x0254, 0x0218, 0x0254, 0x021A, 0x0254, 0x0682, 0x0254, 0x0682, 0x0254, 0x0682, 0x0254, 0x0680, 0x0254, 0x0682, 0x0254, 0x0218, 0x0254, 0x021A,
	0x0254, 0x0682, 0x0254, 0x0682, 0x0254, 0x0218, 0x0254, 0x0218, 0x0254, 0x0218, 0x0254, 0x0218, 0x0254, 0x0684, 0x0252, 0x0696, 0x0240, 0x021A,
	0x0252, 0x021A, 0x0252, 0x0684, 0x0252, 0x0696, 0x0242, 0x0682, 0x0254, 0x0682, 0x0252, 0x021A, 0x0252, 0x9316, 0x2328, 0x08C0, 0x0238,	0xBC80,
	0x0010, 0xBC70, 0x2326, 0x08D4, 0x0252, 0x0100 };
/******************************************************************************
 * FunctionName : irc_mi_tv_make_and_send_code
 * Description  : 生成红外遥控命令码并进行发送
 * Parameters   : none
 * Returns      : none
*******************************************************************************/
void irc_chengmai_can_tv_make_and_send_code(uint8_t key)
{
    /*命令码*/
    switch (key)
    {
        case TVBOX_KEY_ONOFF :
            irc_can_tv.ir_code[0] = TV_CMD_ONOFF;
            break;
        case TVBOX_KEY_VOLUME_PLUS :
            irc_can_tv.ir_code[0] = TV_CMD_VOLUME_PLUS;
            break;
        case TVBOX_KEY_VOLUME_REDUCE :
            irc_can_tv.ir_code[0] = TV_CMD_VOLUME_REDUCE;
            break;
		case TVBOX_KEY_VOLUME_MUTTE :
            irc_can_tv.ir_code[0] = TV_CMD_MUTTE;
            break;
		case TVBOX_KEY_CHANNEL_PLUS :
            irc_can_tv.ir_code[0] = TV_CMD_UP;
            break;
		case TVBOX_KEY_CHANNEL_REDUCE :
            irc_can_tv.ir_code[0] = TV_CMD_DOWN;
            break;
        default :
            ;
    }
    
    /*命令码存入缓冲*/
    ringbuffer_write(&ringbuffer_can_tv, irc_can_tv.ir_code, 1, 0, 0, 1);
}

/******************************************************************************
 * FunctionName : irc_mi_tv_code_to_timing
 * Description  : 由红外遥控命令码生成时序
 * Parameters   : none
 * Returns      : none
*******************************************************************************/
static void irc_chengmai_can_tv_code_to_timing(uint8_t *pcode)
{
    memset(irc_can_tv.ir_timing,0,sizeof(irc_can_tv.ir_timing));
    switch (pcode[0])
    {
        case TV_CMD_ONOFF :
			memcpy(irc_can_tv.ir_timing, chengmai_can_tv_timing_onoff, sizeof(uint16_t) * IRC_CHENGMAI_CAN_TV_TIMING_LEN);
            break;
        case TV_CMD_VOLUME_PLUS :
            memcpy(irc_can_tv.ir_timing, chengmai_can_tv_timing_volume_plus, sizeof(uint16_t) * IRC_CHENGMAI_CAN_TV_TIMING_LEN);
            break;
        case TV_CMD_VOLUME_REDUCE :
            memcpy(irc_can_tv.ir_timing, chengmai_can_tv_timing_volume_reduce, sizeof(uint16_t) * IRC_CHENGMAI_CAN_TV_TIMING_LEN);
            break;
		case TV_CMD_MUTTE :
            memcpy(irc_can_tv.ir_timing, chengmai_can_tv_timing_mutte, sizeof(uint16_t) * IRC_CHENGMAI_CAN_TV_TIMING_LEN);
            break;
		case TV_CMD_UP :
            memcpy(irc_can_tv.ir_timing, chengmai_can_timing_up, sizeof(uint16_t) * IRC_CHENGMAI_CAN_TV_TIMING_LEN);
            break;
		case TV_CMD_DOWN :
            memcpy(irc_can_tv.ir_timing, chengmai_can_timing_down, sizeof(uint16_t) * IRC_CHENGMAI_CAN_TV_TIMING_LEN);
            break;
        default :
            ;
    }
    
    irc_can_tv.ir_num = IRC_CHENGMAI_CAN_TV_TIMING_LEN;
}


/******************************************************************************
 * FunctionName : irc_mi_tv_send_task
 * Description  : 红外遥控发码任务
 * Parameters   : none
 * Returns      : none
*******************************************************************************/
void irc_chengmai_can_tv_send_task(void)
{
    uint8_t ir_code_temp[IRC_CHENGMAI_CAN_TV_CODE_LEN];
    uint16_t time_out;
    
    if (ringbuffer_read(&ringbuffer_can_tv, ir_code_temp, IRC_CHENGMAI_CAN_TV_CODE_LEN))
    {
        irc_chengmai_can_tv_code_to_timing(ir_code_temp);
        irc_output_num = irc_can_tv.ir_num;
        memcpy(irc_output_timing, irc_can_tv.ir_timing, irc_output_num * 2);
        irc_output_start();
        
        time_out = 1000;
        while (irc_output_busy_flag)
        {
            if (time_out-- == 0)
                break;
        }
    }
}

/******************************************************************************
 * FunctionName : irc_mi_tv_init
 * Description  : 红外遥控功能初始化
 * Parameters   : none
 * Returns      : none
*******************************************************************************/
void irc_chengmai_can_tv_init(void)
{
    ringbuffer_init(&ringbuffer_can_tv);                     //初始化循环缓冲区
}
