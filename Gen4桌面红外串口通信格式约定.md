# 串口通信格式约定

更改日志:

        V0.3: 对修改“红外码写入”中对红外数据长度及包序号的描述。

                  修改“设置IRCReady状态”命令格式。

                  修改“红外码上报”使用注意

        V0.2: 修复偏移位置计算公式错误。

        V0.1: 基础版本建立。

## 1.基础格式

| 包头（三字节）  | 命令（单字节） | 数据长度（单字节）  | 数据    | 校验和[2] | 校验和[2] | 包尾（三字节）  |
|:--------:|:-------:|:----------:| ----- | ------ | ------ | -------- |
| 0x1D63C0 | 详见命令表   | 最大长度255[1] | 详见命令表 | Sum(H) | Sum(L) | 0x2D3153 |

**注：**

[1]其最大长度指数据长度。当数据长度为0时不应在数据位填充占位字。

[2]其对除包头及包尾外所有数据进行和校验，并将结果放置在此。

[3]***以下命令码编写时默认忽略数据长度位，需组包时自行填充。***

[4]部分命令操作时间较长，发送多条命令时应等待上条命令的回复。握手命令总是可用的。可用于设备连接性检查。

## 2.命令表

### 0. 命令表一览

| CMD  | Function                    |
| ---- | --------------------------- |
| 0x00 | 握手及获取设备状态                   |
|      |                             |
| 0x01 | 写入存储索引                      |
| 0x02 | 获取存储索引总数                    |
| 0x03 | 读取存储索引                      |
| 0x04 | 擦除存储索引                      |
| 0x0D | 设置IRCReady状态                |
|      |                             |
| 0x05 | 红外码写入                       |
| 0x06 | 红外码读取                       |
| 0x07 | 已使用空间                       |
| 0x0A | 已接收包信息                      |
| 0x0C | ***删除指定红外码***  (未实现，功能暂停开发) |
|      |                             |
| 0x08 | 红外码捕获状态                     |
| 0x09 | 红外码回报                       |
| 0x0B | 写入当前捕获码                     |
| 0x0E | 写入捕获数组及测试红外码                |
| 0x0F | 直接发送已捕获到的红外码                |
|      |                             |
| 0x12 | 清空flash芯片                   |

### 1.握手

***发送：***

| CMD  |
| ---- |
| 0x00 |

***回复:***

| CMD  | Data1              | Data2        |
| ---- | ------------------ | ------------ |
| 0x00 | 0xCC/0x00/0x01 [1] | FlashSize[2] |

**注：**

        [1]当返回“0xCC”时表设备正常，可以进行下一步操作。当返回“0x00”时表示存储设备失效。当返回“0x01”时表示红外收发设备失效。

        [2] FlashSize需要进行计算以转换为实际容量（FlashSize为单字节数），其表示 “2的(FlashSize)的幂次 ”个字节，即（2^(FlashSize)）Byte。当"Data1"回复不为“0xCC”时应忽略此位。

### 2.存储引导写入

        存储引导应是对红外码操作的第一步，此处置位缺失会导致设备无法按相关标志位移动读写红外码。

#### 2.1 偏移地址计算

        每个被控设备其操作码均抽象为对被控设备存储首地址的偏移，故需要先对存储区块位置的关系进行声明。但这并非上位机需要关心的实际位置关系，其各项仅表示内部设备的偏移基数。是设备写入及发送相关数据的参照。缺少此项则设备无法发送红外码。

        存储引导默认占用设备的首个扇区（4K Byte），故当需要评估红外码是否足够写入存储设备时应减去引导所占用的大小。

        由于下位机内存不足，当对某一区域进行修改时设备会请求被修改扇区内的全部内容。

        

       偏移算子的计算方式如下例：

$$
Offset1 = OffsetNum1 * OffsetBase1
$$

        可以认为最终偏移位置的计算方式为:

$$
ReadAddr = DevBase + (Offset1 * Offset2 * Offset3 *...)*IRcodeLen
$$

则以空调码为例：

        DevNum指当前设备号，此时仅有此一个设备其值为0。

         DevBase指当前设备对应的储存基地址，为设备自动分配。

        Offset1 为空调温度、其起始值为0对应空调温度16 、温度每上升一度则OffsetNum1加一，

        Offset2为空调模式、其起始值0对应制冷模式、其他模式存在则OffsetNum2加一，

        Offset3为风速、其起始值0对应低风速、其他风速存在则OffsetNum3加一。

        则各项为零时，ReadAddr其地址内容为 "16度，制冷，低风速"。

        

        对于Offset1

$$
OffsetBase1 = TemperatureMax - TemperatureMin
$$

        对于Offset2

$$
OffsetBase2 = ModeMax - ModeMin
$$

        对于Offset3

$$
OffsetBase3 = SpeedMax - SpeedMin
$$

       IRcodeLen指单条指令红外码长度。

故应当注意，红外设备现不再关心设备类型，其对红外码的所有操作均将会以存储首地址偏移的方式进行。故需要上位机自行判断“DevType”即设备类型，其对下位机而言仅做索引配对使用。

#### 2.2 写入存储索引

***发送：[1]***

| CMD  | Data1  | Data2   | Data3[5]     | Data4        | Data5[6]    | Data6[7]         | Data7            | ... |
| ---- | ------ | ------- | ------------ | ------------ | ----------- | ---------------- | ---------------- | --- |
| 0x01 | DevNum | DevType | IRCodeLen(H) | IRCodeLen(L) | OffsetTotal | OffsetBase1Total | OffsetBase2Total | ... |

***回复：***

| CMD  | Data1         |
| ---- | ------------- |
| 0x01 | 0xCC/ECode[2] |

**注：**

        [1] 一个设备可以不拥有任何偏移算子，即传输时将“OffsetTotal”设定为0后停止填充数据。

        [2] 此处可能出现的错误标识

| Ecode | 错误原因                           |
| ----- | ------------------------------ |
| 0xCC  | 写入成功                           |
| 0xE0  | 包格式错误                          |
| 0xE1  | 当前位置已存在索引，但删除错误                |
| 0xE2  | 偏移算子总数存在0值                     |
| 0xE3  | 设备储存地址分配失败。数据量过大或外部储存器已无足够空间可用 |
| 0xE4  | 索引写入失败。                        |
| 0xE5  | 存储写入成功但交叉检查失败。                 |

        [3] "DevNum"是设备读取红外码的唯一标识，且其应该是自零开始连续增加的。对存储索引进行操作时应注意其唯一性。

        [4] "DevType"则负责转换设备编号与通信过程中可能存在的设备识别类型作为匹配，此值应对同一房间中的设备是唯一的。其组成高四位指现有设备类型，低四位指设备编号以应对同一房间中存在同种设备类型但红外码不同的的多个设备。（如同一个房间中的两个电视。）

        [5]“IRCodeLen”表示，串口传输长度。且其必为偶数。若为奇数将直接返回错误。还需注意，此处长度应考虑超长码间隔值的存在。

        [6]此处应该填写的是当前索引中对应的偏移算子的总数。即有多少个可选的偏移算子。

        [7]此处填充的应是对应当前位的偏移算子的总数，即一个偏移算子中对应有多少个可用的偏移数总数。总数不能为0。

#### 2.2获取存储索引总数

***发送:***

| CMD  |
| ---- |
| 0x02 |

***回复：***

| CMD  | Data1    | Data2          | Data3          | ... |
| ---- | -------- | -------------- | -------------- | --- |
| 0x02 | MaxIndex | RemovedDevNum1 | RemovedDevNum2 | ... |

注 ：

        “MaxIndex”实际返回当前设备内最大“DevNum”值。

        "RemovedDevNum1"指除最大最大值外，中间空缺的DevNum。当存在多个空缺时会返回多个编号,若不存在空缺则只返回“MaxIndex”。

#### 2.3读取存储索引

***发送:***

| CMD  | Data1  |
| ---- | ------ |
| 0x03 | DevNum |

***回复:***

| CMD  | Data1  | Data2   | Data3[1] | Data4[2]     | Data5        | Data6       | Data7       | Data8       | ... |
| ---- | ------ | ------- | -------- | ------------ | ------------ | ----------- | ----------- | ----------- | --- |
| 0x03 | DevNum | DevType | IRCReady | IRCodeLen(H) | IRCodeLen(L) | OffsetTotal | OffsetBase1 | OffsetBase2 | ... |

        注：

        [1]“IRCReady”指IR_Code区中对应实际存储位置红外码部分是否准备就绪。由上位机置位，此位置位后设备才会去搜索偏移地址进行红外码发送。（置位时为0xCC。其余值均为未至置位）

        [2]“IRCodeLen”表示双字节红外码长度，串口传输长度，其返回值包含超长码间隔值长度。

        [3]可能的错误码

| Ecode | 错误原因  |
| ----- | ----- |
| 0xE0  | 包格式错误 |
| 0xE1  | 读索引失败 |

#### 2.4擦除存储索引

***发送:***

| CMD  | Data1  | Data2 | Data3 |
| ---- | ------ | ----- | ----- |
| 0x04 | DevNum | 0x44  | 0x4C  |

***回复:***

| CMD  | Data1      |
| ---- | ---------- |
| 0x04 | 0xCC/Ecode |

注：擦除会清除“DevNum”的全部信息。包括存储索引与IRcode区域。

| Ecode | 错误原因        |
| ----- | ----------- |
| 0xCC  | 写入成功        |
| 0xE0  | 包格式错误       |
| 0xE1  | 对应位置索引不存在   |
| 0xE2  | 内存不足，空间分配失败 |
| 0xE3  | 读取索引内容失败    |

#### 2.5 设置IRCReady状态

***发送:***

| CMD  | Data1  | Data2 |
| ---- | ------ | ----- |
| 0x0D | DevNum | 0xCC  |

***回复:***

| CMD  | Data1      |
| ---- | ---------- |
| 0x0D | 0xCC/Ecode |

注：发送包“Data1”指设置“IRCReady”状态，“0x01”时置位“IRCReady”，当“0x00”时清空对应设备号所有引导信息。

### 3 红外码操作

对红外码的写入操作应在存储索引写入后，因其相关操作码并不包含地址偏移基数，仅包含偏移量。

#### 3.1红外码写入

***发送:***

| CMD  | Data1  | Data2[1] | Data3[1]  | Data4[2] | Data5[3]   | Data6      | ... | Data n        | Data n+1 [4] | Data n+2    | ... |
| ---- | ------ | -------- | --------- | -------- | ---------- | ---------- | --- | ------------- | ------------ | ----------- | --- |
| 0x05 | DevNum | PackNum  | PackTotal | CodeLen  | Offset1Num | Offset2Num | ... | Offset_n_ Num | IRCCode1(H)  | IRCCode1(L) | ... |

***回复:***

| CMD  | Data1  | Data2   | Data3     | Data4      | Data5      | Data6      | ... |
| ---- | ------ | ------- | --------- | ---------- | ---------- | ---------- | --- |
| 0x05 | DevNum | PackNum | PackTotal | 0xCC/Ecode | Offset1Num | Offset2Num | ... |

注：

        [1] 此处包序号及总包大小需要提前计算填充，其是下位机数据包合成的依据。包序号起始值为0。

        [2] 此处“CodeLen”长度指实际传输IRCCode长度，是指串口传输过程中的红外数据长度。且其应为偶数，最大值为100。除最后一包数据外，其值不应存在变动。

        [3]此处指各偏移算子中的偏移量，同一包红外数据此处不应更改，且传输数量应与存储索引中的偏移算子总数匹配。

        [4]此处即传输红外码编码，按照16位数据格式传输，需要注意的是，由于红外码编码存在超长码，其数据长度超过MAX_UINT16，会破坏后续所有数据的高低翻转状态，故需要特殊化处理。 此处提前约定当出现超长数据，应在传输时提前计算，使其第一个红外码值为0xFFFF,后再插入一个0xFFFFF，在之后的一个地址填充超出16位地址的数据。

例如：

        “ForwardCode(H),ForwardCode(L), 0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,(OverLengthCode - 0xFFFF) (H),(OverLengthCode - 0xFFFF)(L) ”

        [5]同一设备号相关的红外码会连续存储，且与其他设备号相关红外码不会共用同一个扇区。

| Ecode值 | 意义                                             |
| ------ | ---------------------------------------------- |
| 0xCC   | 成功                                             |
| 0xE0   | 组包错误                                           |
| 0xE1   | DevNum对应索引未写入.                                 |
| 0xE2   | 对应devnum读取数据与组包传递数据不符                          |
| 0xE3   | DevNum对应索引未成功分配Flash 地址，需要清理Flash或检查索引分配地址是否过多 |
| 0xE4   | 当前包内存在偏移算子数大于索引内记录的对应位偏移算子最大值                  |
| 0xE5   | 数据覆写。当前包对应地址已经被写入数据。                           |

#### 3.2红外码读取

***发送:***

| CMD  | Data1  | Data2[1] | Data3[1] | Data4[3]   | Data5      | ... | Data n        |
| ---- | ------ | -------- | -------- | ---------- | ---------- | --- | ------------- |
| 0x06 | DevNum | PackNum  | PackTota | Offset1Num | Offset2Num | ... | Offset_n_ Num |

***回复:***

| CMD  | Data1  | Data2[1] | Data3[1]  | Data4[2] | Data5[3]   | Data6      | ... | Data n        | Data n+1 [4] | Data n+2    | ... |
| ---- | ------ | -------- | --------- | -------- | ---------- | ---------- | --- | ------------- | ------------ | ----------- | --- |
| 0x06 | DevNum | PackNum  | PackTotal | CodeLen  | Offset1Num | Offset2Num | ... | Offset_n_ Num | IRCCode1(H)  | IRCCode1(L) | ... |

注：

        [1] 在第一次请求此处应填“0”并等待设备第一次回包。设备第一次回复会回报总包数，之后上位机获取红外码应设置包号及总包数，否则下位机将持续回报第一包数据。

        [2] 此处“CodeLen”长度指实际传输IRCCode长度，是双字节红外码长度非串口传输长度。

        [3] 此处指各偏移算子中的偏移量，同一包红外数据此处不更改。

#### 3.3 查询已使用空间

***发送:***

| CMD  | Data1        |
| ---- | ------------ |
| 0x07 | 0x01/0x02[1] |

***回复:*** (Data1: 0x01)

| CMD  | Data1 | Data2        | Data3        |
| ---- | ----- | ------------ | ------------ |
| 0x07 | 0x01  | UsedSpace(H) | UsedSpace(L) |

***回复:*** (Data1: 0x02)

| CMD  | Data1 | Data2           | Data3           | Data4          | Data5         |
| ---- | ----- | --------------- | --------------- | -------------- | ------------- |
| 0x07 | 0x02  | UsedSize(31-24) | UsedSize(23-16) | UsedSize(15-8) | UsedSize(7-0) |

注：

        [1] 子参数0x01指查询当前已占用总扇区数，其返回值即扇区个数，返回值类型为16位。

        [2] 子参数0x02指查询实际占用字节数，返回值类型为Uint32_t。

#### 3.4 已接收包消息

***发送:***

| CMD  |
| ---- |
| 0x0A |

***回复:***

| CMD  | Data1  | Data2   | Data3     |
| ---- | ------ | ------- | --------- |
| 0x0A | DevNum | PackNum | PackTotal |

注意此处位置消息需要在调用红外码写入后才会被置位，否则返回值无意义。

### 4. 红外捕获

当上位机使能红外捕获后，下位机每当获取到一条可能的红外码后会立即进行上报。

同时需要注意，此命令与红外码写入互斥，当正在进行红外码写入时无法使能红外码捕获，反之亦然。

#### 4.1 使能红外码捕获

***发送:***

| CMD  | Data1[1]  |
| ---- | --------- |
| 0x08 | 0x00/0x01 |

***回复:***

| CMD  | Data1[1]  | Data2[2]  |
| ---- | --------- | --------- |
| 0x08 | 0x00/0x01 | 0xCC/0XE1 |

注：

        [1] 当此位为“0x00”时失能红外码捕获，为"0x01"时使能红外码捕获。

        [2] 成功时返回“0xCC”反之为失败。

#### 4.2 红外码上报

***发送:（下位机）***

| CMD  | Data1   | Data2     | Data3   | Data4       | Data5       | ... |
| ---- | ------- | --------- | ------- | ----------- | ----------- | --- |
| 0x09 | PackNum | PackTotal | CodeLen | IRCCode1(H) | IRCCode1(L) | ... |

***回复:***

| CMD  | Data1   | Data2     | Data3   |
| ---- | ------- | --------- | ------- |
| 0x09 | PackNum | PackTotal | Stat[1] |

注：

        [1] Stat 配置为“0xCC”为接收成功，当“PackNum”小于 “PackTotal”时 会自增发送下一包数据直到发送完毕；“0x01”为重发“PackNum”所指定的包；“0x02”为终止传输。设备将释放本次所获取到的数据。直到获取到新数据。

        [2] 当设备中存在红外码未传输完毕且上位机未停止传输或未停止红外码捕获时不应进行红外码写入等操作。如果进行此操作可能直接导致设备堆栈溢出。

当出现错误及发送清除缓存时，下位机的回包格式如：

| CMD  | Data1   | Data2     | Data3   | Data4      |
| ---- | ------- | --------- | ------- | ---------- |
| 0x09 | PackNum | PackTotal | Stat[1] | 0xCC/Ecode |

可能出现的Ecode 含义

| Ecode | 意义     |
| ----- | ------ |
| 0xE0  | 包格式错误  |
| 0xE1  | 包序号不存在 |
| 0xCC  | 清除缓存成功 |

#### 4.3 写入当前捕获码

***发送:***

| CMD  | Data1  | Data2      | Data3      | ... |
| ---- | ------ | ---------- | ---------- | --- |
| 0x0B | DevNum | Offset1Num | Offset2Num | ... |

***回复:***

| CMD  | Data1      |
| ---- | ---------- |
| 0x0B | 0xCC/ECode |

此命令将会将最后一次向上位机发送的包转入存储设备。使用此命令时需要提前设置存储索引。否则会直接返回失败。

可能出现的Ecode 含义

| Ecode | 意义                    |
| ----- | --------------------- |
| 0xE0  | 包格式错误                 |
| 0xE1  | 写入目标索引数据未被写入          |
| 0xE2  | 索引数据存储地址分配失败          |
| 0xE3  | 已传递的索引偏移算子总数与索引记录数据不符 |
| 0xE4  | 已传递的索引红外数据总数与索引记录数据不符 |
| 0xE5  | 红外数据缓存不存在             |
| 0xE6  | 数据覆写。                 |

#### 4.4 写入捕获数组及测试红外码

***发送:***

| CMD  | Data1         | Data2        | Data3        | Data4   | Data5       | Data6       | ...... |
| ---- | ------------- | ------------ | ------------ | ------- | ----------- | ----------- | ------ |
| 0x0E | WorkStatus[1] | IRCodeLen(H) | IRCodeLen(L) | CodeLen | IRCCode1(H) | IRCCode1(L) | ...... |

***回复:***

| CMD  | Data1         | Data2         | Data3              | Data4           |
| ---- | ------------- | ------------- | ------------------ | --------------- |
| 0x0E | WorkStatus[1] | 0xCC/ECode[2] | RecIRCodeLen(H)[3] | RecIRCodeLen(L) |

[1] 此处为上位机指示下位机状态存在三个可选值

| WorkStatus值 | 功能                            |
|:-----------:| ----------------------------- |
| 0           | 传递第一个包数据并通告待传输红外数据总数          |
| 1           | 传递除第一包数据外其他待传递数据直到传输完成，可以不存在。 |
| 2           | 红外码发射，此操作会清空下位机数据缓冲           |

[2] 此处可能出现的错误标识

| Ecode | 错误原因                        |
| ----- | --------------------------- |
| 0xE0  | 包格式错误                       |
| 0xE1  | malloc失败，无法开辟出足够的空间.包传输格式错误 |
| 0xE2  | 红外码长度超出支持范围                 |
| 0xE3  | 未经过状态0                      |
| 0xE4  | 未经过状态0或已传输红外数据大于总数          |

当此处值不为0xCC时需要从头传递数据，触发任何错误都会清除接收数据缓冲区。

[3] 此处传递已经接受到的红外数据长度，如果想查询当前设备已接收到的数据数据使用WorkStatus 1 ，并将 CodeLen 置 0 。

#### 4.5 直接发送已捕获到的红外码

***发送:***

| CMD  |
| ---- |
| 0x0F |

***回复:***

| CMD  | Data1         |
| ---- | ------------- |
| 0x0F | 0xCC/Ecode[1] |

此命令会将上一次使能红外捕获获得的数据发送出去，并清空数据缓冲。
[1] 此处可能出现的错误标识

| Ecode | 错误原因         |
| ----- | ------------ |
| 0xE1  | 未查询到有效红外缓冲数据 |
| 0xE0  | 包传输格式错误      |

### 5. 测试功能

测试用快捷功能

#### 5.1 清空flash 存储

***发送:***

| CMD  | Data1 | Data2 |
| ---- | ----- | ----- |
| 0x12 | 0xCD  | 0xCA  |

***回复:***

| CMD  | Data1     |
| ---- | --------- |
| 0x12 | 0xCC/0x00 |

注：擦除会清除flash的全部信息。